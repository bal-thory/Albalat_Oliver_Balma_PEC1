---
title: "PAC 1 Dades omiques"
author: "Balma Albalat Oliver"
output:
  word_document: default
---

#INFORME
##1.DESCRIPCIÓ I JUSTIFICACIO DE LA BASE DE DADES
## He triat la database associada al projecte Metabolomics of Psoriasis.
## Aquesta pot consular-se en el repositori "Metabolomics workbench" amb l'identificador de projecte PR000239.
## He triat aquest tema perquè pateixo aquesta malaltia i m'ha causat curiositat #aprofundir en aquesta qüestió.
## Es tracta d'un estudi desenvolupat pel Departament de Dermatologia de la Universitat de Michigan, dirigit per l'investigador Johann Gudjonsson. L'objectiu de l'estudi és estudiar els metabolits esteroides en els teixits de pacients amb diferents estats de psoriasis. Per assolir-lo es van realitzar biòpsis per obtenir 9 mostres de pell que es van categoritzar en 3 subgrups:

#-Pell sana (3) -Pell afectada per psoriasis (3) -Pell no afectada en pacients amb psoriasis (3)

#A través de la cromatografía líquida acoplada a l'espectrometria de masses (LC-MS) es van analitzar les concentracions d'esteroides, expressades en pg/mg de teixit, caracteritzant d'aquesta manera els perfils metabòlics de cada mostra de pell.

```{r packages}
if(!require(jsonlite)){
    install.packages("jsonlite")
    library(jsonlite)}
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
if (!require("ggtext", quietly = TRUE))
    install.packages("ggtext")
if (!require("magrittr", quietly = TRUE))
    install.packages("magrittr")
if (!require("dplyr", quietly = TRUE))
    install.packages("dplyr")
if (!require("tidyr", quietly = TRUE))
    install.packages("tidyr")
if (!require("tibble", quietly = TRUE))
    install.packages("tibble")
if (!require("purrr", quietly = TRUE))
    install.packages("purrr")
if (!require("readr", quietly = TRUE))
    install.packages("readr")
if (!requireNamespace("SummarizedExperiment", quietly = TRUE)) {
  install.packages("SummarizedExperiment")
}
if (!requireNamespace("ggplot2", quietly = TRUE)) {
  install.packages("ggplot2")
}
BiocManager::install("Biobase")
BiocManager::install("POMA")
BiocManager::install("SummarizedExperiment")
library(POMA)
library(ggtext)
library(magrittr)
library(SummarizedExperiment)
library(readr)
library(purrr)
library(ggplot2)
```

```{r data_prep}

##### PREPARACIÓ I IMPORTACIÓ DE LES DADES ####

# Importar l'arxiu de dades '.json'

library(jsonlite)
json_data <-jsonlite::fromJSON("ST000298_AN000476.json", flatten = TRUE)
# Cerquem i resolem valors nuls #
null_values <- sapply(json_data, function(x) any(is.null(x)))
na_values <- sapply(json_data, function(x) any(is.na(x)))
# Print results
print("Valors nuls en:")
print(names(json_data)[null_values])

### Creació colData (info i factor mostres) ###
# Extraem la info de json_data
if (is.data.frame(json_data$SUBJECT_SAMPLE_FACTORS)) {
  sample_df <- json_data$SUBJECT_SAMPLE_FACTORS
} else {
  sample_info <- as.character(unlist(data$SUBJECT_SAMPLE_FACTORS))
  sample_df <- read.table(text = sample_info, sep = "\t", header = FALSE, stringsAsFactors = FALSE)
}
colnames(sample_df) <- c("Subject", "SampleID", "Factors")

# Associem els factors a columnes i creem colData#

# Crear un DataFrame de factores
factor_df <- data.frame(Factor = sample_df$Factors)

# Combinar con el DataFrame original
colData <- cbind(sample_df[, "SampleID", drop = FALSE], factor_df)

# Asignar nombres a las filas
row.names(colData) <- colData$SampleID

# Ver el resultado
head(colData)



### Extreuracció de dades metabòliques (fe) ###
# L'utilitzarem per a fer els anàlisi #

metabolite_data<-json_data$MS_METABOLITE_DATA$Data
metabolite_matrix <- as.data.frame(metabolite_data)
rownames(metabolite_matrix) <- metabolite_matrix$Metabolite
metabolite_matrix <- metabolite_matrix[, -1]  # 
metabolite_matrix <- t(metabolite_matrix)
metabolite_matrix <- as.matrix(sapply(metabolite_matrix, as.numeric))
head(metabolite_matrix)


metabolite_data <- json_data$MS_METABOLITE_DATA$Data
metabolite_matrix <- as.data.frame(metabolite_data)
rownames(metabolite_matrix) <- metabolite_matrix$Metabolite
metabolite_matrix <- metabolite_matrix[, -1]  # Eliminar la columna redundant
metabolite_matrix[metabolite_matrix == ""] <- NA
metabolite_matrix <- as.matrix(sapply(metabolite_matrix, as.numeric))
head(metabolite_matrix)
```

2.  CREAR OBJECTE 'SummarizedExperiment'
```{r SumExp}


# Eliminar la fila 5, que conté la info del metabolit amb dades faltants

metabolite_matrix <- metabolite_matrix[-5, ]
metabolite_matrix <-t(metabolite_matrix)
colData <- colData[!rownames(colData) %in% "Corticosterone", ]

# Comprovem que coincideixen les files

nrow(metabolite_matrix)
nrow(colData)

# Generm el SummarizedExperiment 

library(POMA)
poma_obj <- PomaCreateObject(
  metadata = colData,   
  features = metabolite_matrix 
)

# Verifiquem

poma_obj

```

3. AFEGIM METADADES GENERALS DEL PROJECTE

```{r Metadata}
# Afegim les metadades a l'objecte SummarizedExperiment
for (key in names(json_data$METABOLOMICS)) {
  metadata(poma_obj)$METABOLOMICS[[key]] <- json_data$METABOLOMICS[[key]]
}
for (key in names(json_data$PROJECT)) {
  metadata(poma_obj)$PROJECT[[key]] <- json_data$PROJECT[[key]]
}

for (key in names(json_data$STUDY)) {
  metadata(poma_obj)$STUDY[[key]] <- json_data$STUDY[[key]]
}

for (key in names(json_data$SUBJECT)) {
  metadata(poma_obj)$SUBJECT[[key]] <- json_data$SUBJECT[[key]]
}

for (key in names(json_data$SUBJECT_SAMPLE_FACTORS)) {
  metadata(poma_obj)$SUBJECT_SAMPLE_FACTORS[[key]] <- json_data$SUBJECT_SAMPLE_FACTORS[[key]]
}

for (key in names(json_data$COLLECTION)) {
  metadata(poma_obj)$COLLECTION[[key]] <- json_data$COLLECTION[[key]]
}

for (key in names(json_data$TREATMENT)) {
  metadata(poma_obj)$TREATMENT[[key]] <- json_data$TREATMENT[[key]]
}

for (key in names(json_data$SAMPLEPREP)) {
  metadata(poma_obj)$SAMPLEPREP[[key]] <- json_data$SAMPLEPREP[[key]]
}

for (key in names(json_data$CHROMATOGRAPHY)) {
  metadata(poma_obj)$CHROMATOGRAPHY[[key]] <- json_data$CHROMATOGRAPHY[[key]]
}

for (key in names(json_data$ANALYSIS)) {
  metadata(poma_obj)$ANALYSIS[[key]] <- json_data$ANALYSIS[[key]]
}

for (key in names(json_data$MS)) {
  metadata(poma_obj)$MS[[key]] <- json_data$MS[[key]]
}

metadata(poma_obj)

```

4. ANÀLISI EXPLORATORI
```{r exploration}

# MISSING VALUES #

#Ja els hem netejat durant la preparació del SummarizedExperiment. Hem eliminat el metabolit 'Corticosterone' que no presentava dades per a totes les mostres.

# CAL NORMALITZAR LES DADES? #


# Dades en cru #
p1<-PomaBoxplots(
  poma_obj, 
  x= "samples",
  feature_name = NULL,)

print(p1)


# Dades normalitzades
normalized<- poma_obj  %>% 
  PomaNorm(method="log_pareto")
p2<-PomaBoxplots(
  normalized,
  x= "samples",
  feature_name = NULL,)

print(p2)

```
